# GoReleaser é…ç½®æ–‡ä»¶
# æ–‡æ¡£: https://goreleaser.com
# ä½œè€…: ruanun
# ç‰ˆæœ¬: 2.0.0

version: 2

before:
  hooks:
    # åœ¨æ„å»ºå‰ç¡®ä¿ä¾èµ–æ˜¯æœ€æ–°çš„
    - go mod tidy
    # æ³¨æ„ï¼šå‰ç«¯æ„å»ºå·²åœ¨ GitHub Actions å·¥ä½œæµä¸­é€šè¿‡ scripts/build-web.sh å®Œæˆ
    # æœ¬åœ°ä½¿ç”¨æ—¶ï¼Œè¯·å…ˆè¿è¡Œ: make build-web æˆ– bash scripts/build-web.sh

builds:
  # Agent æ„å»ºé…ç½®
  - id: agent
    main: ./cmd/agent
    binary: sss-agent
    env:
      - CGO_ENABLED=0
    goos:
      - linux
      - windows
      - darwin
      - freebsd
    goarch:
      - amd64
      - arm64
      - arm
    goarm:
      - "7"
    ignore:
      - goos: windows
        goarch: arm
      - goos: windows
        goarch: arm64
      - goos: darwin
        goarch: arm
      - goos: freebsd
        goarch: arm
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    flags:
      - -trimpath

  # Dashboard æ„å»ºé…ç½®
  - id: dashboard
    main: ./cmd/dashboard
    binary: sss-dashboard
    env:
      - CGO_ENABLED=0
    goos:
      - linux
      - windows
      - darwin
      - freebsd
    goarch:
      - amd64
      - arm64
      - arm
    goarm:
      - "7"
    ignore:
      - goos: windows
        goarch: arm
      - goos: windows
        goarch: arm64
      - goos: darwin
        goarch: arm
      - goos: freebsd
        goarch: arm
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    flags:
      - -trimpath

archives:
  # Agent ç‹¬ç«‹åŒ…
  - id: agent
    builds: [agent]
    format: tar.gz
    wrap_in_directory: true
    name_template: >-
      sss-agent_
      {{- .Version }}_
      {{- .Os }}_
      {{- .Arch }}
      {{- if .Arm }}v{{ .Arm }}{{ end }}
    format_overrides:
      - goos: windows
        format: zip
    files:
      - README.md
      - LICENSE
      - configs/sss-agent.yaml.example
      - deployments/systemd/sssa.service

  # Dashboard ç‹¬ç«‹åŒ…
  - id: dashboard
    builds: [dashboard]
    format: tar.gz
    wrap_in_directory: true
    name_template: >-
      sss-dashboard_
      {{- .Version }}_
      {{- .Os }}_
      {{- .Arch }}
      {{- if .Arm }}v{{ .Arm }}{{ end }}
    format_overrides:
      - goos: windows
        format: zip
    files:
      - README.md
      - LICENSE
      - configs/sss-dashboard.yaml.example

checksum:
  name_template: 'checksums.txt'
  algorithm: sha256

snapshot:
  name_template: "{{ incpatch .Version }}-next"

changelog:
  sort: asc
  use: github
  filters:
    exclude:
      - '^docs:'
      - '^test:'
      - '^chore:'
      - '^ci:'
      - 'merge conflict'
      - Merge pull request
      - Merge remote-tracking branch
      - Merge branch
  groups:
    - title: 'ğŸ‰ æ–°åŠŸèƒ½'
      regexp: '^.*?feat(\([[:word:]]+\))??!?:.+$'
      order: 0
    - title: 'ğŸ› Bug ä¿®å¤'
      regexp: '^.*?fix(\([[:word:]]+\))??!?:.+$'
      order: 1
    - title: 'ğŸ“ æ–‡æ¡£æ›´æ–°'
      regexp: '^.*?docs(\([[:word:]]+\))??!?:.+$'
      order: 2
    - title: 'ğŸš€ æ€§èƒ½ä¼˜åŒ–'
      regexp: '^.*?perf(\([[:word:]]+\))??!?:.+$'
      order: 3
    - title: 'â™»ï¸ ä»£ç é‡æ„'
      regexp: '^.*?refactor(\([[:word:]]+\))??!?:.+$'
      order: 4
    - title: 'å…¶ä»–æ›´æ”¹'
      order: 999

release:
  github:
    owner: ruanun
    name: simple-server-status
  draft: false
  prerelease: auto
  mode: replace
  name_template: "{{.ProjectName}} v{{.Version}}"
  header: |
    ## Simple Server Status v{{.Version}}

    ğŸ‰ æ¬¢è¿ä½¿ç”¨ Simple Server Statusï¼

    ### å¿«é€Ÿå®‰è£…

    **Agent ä¸€é”®å®‰è£…ï¼š**
    ```bash
    # Linux/macOS/FreeBSD
    curl -fsSL https://raw.githubusercontent.com/ruanun/simple-server-status/main/scripts/install-agent.sh | bash

    # Windows (PowerShell)
    iwr -useb https://raw.githubusercontent.com/ruanun/simple-server-status/main/scripts/install-agent.ps1 | iex
    ```

    **Dashboard Docker éƒ¨ç½²ï¼š**
    ```bash
    docker run --name sssd -d -p 8900:8900 -v ./sss-dashboard.yaml:/app/sss-dashboard.yaml ruanun/sssd:{{.Version}}
    ```

    ### ğŸ“¦ ä¸‹è½½è¯´æ˜

    - `sss-agent`: ç›‘æ§ä»£ç†å®¢æˆ·ç«¯
    - `sss-dashboard`: ç›‘æ§é¢æ¿æœåŠ¡ç«¯

    è¯·æ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿå’Œæ¶æ„é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ä¸‹è½½ã€‚

  footer: |
    ---

    **å®Œæ•´æ–‡æ¡£ï¼š** https://github.com/ruanun/simple-server-status/blob/master/README.md

    **é—®é¢˜åé¦ˆï¼š** https://github.com/ruanun/simple-server-status/issues

    æ„Ÿè°¢ä½¿ç”¨ Simple Server Statusï¼ â­

# æ³¨é‡Šæ‰ nfpms éƒ¨åˆ†ï¼Œå¦‚æœéœ€è¦ç”Ÿæˆ Linux åŒ…å¯ä»¥å–æ¶ˆæ³¨é‡Š
# nfpms:
#   - id: default
#     package_name: simple-server-status
#     homepage: https://github.com/ruanun/simple-server-status
#     maintainer: ruan <your-email@example.com>
#     description: æç®€æœåŠ¡å™¨ç›‘æ§æ¢é’ˆ
#     license: MIT
#     formats:
#       - deb
#       - rpm
#     bindir: /usr/local/bin
